# OSPF

Создать домашнюю сетевую лабораторию. Научиться настраивать протокол OSPF в Linux-based системах.

-------------------------------------------------------------------------------------------------

Домашнее задание:

1. Развернуть 3 виртуальные машины

2. Объединить их разными vlan

- настроить OSPF между машинами на базе Quagga;

- изобразить асимметричный роутинг;

- сделать один из линков "дорогим", но что бы при этом роутинг был симметричным.

--------------------------------------------------------------------------------------------------

# 1. Разворачиваем 3 виртуальные машины

Так как мы планируем настроить OSPF, все 3 виртуальные машины должны быть соединены между собой (разными VLAN), а также иметь одну (или несколько) дополнительных сетей, к которым, далее OSPF сформирует маршруты.

`vagrant up`

Результатом выполнения данной команды будут 3 созданные виртуальные машины, которые соединены между собой сетями (10.0.10.0/30, 10.0.11.0/30 и 10.0.12.0/30). У каждого роутера есть дополнительная сеть:


- на router1 — 192.168.10.0/24

- на router2 — 192.168.20.0/24

- на router3 — 192.168.30.0/24

На данном этапе ping до дополнительных сетей (192.168.10-30.0/24) с соседних роутеров будет недоступен.

Пакет `Quagga` перестал развиваться в 2018 году. Ему на смену пришёл пакет `FRR`, он построен на базе `Quagga` и продолжает своё развитие. В данном домашнем задании настойка `OSPF` будет осуществляться в `FRR`.

--------------------------------------------------------------------------------------------------

# 2.1. Настройка OSPF между машинами на базе пакета FRR

1. Отключаем фаерволл ufw и удаляем его из автозагрузки:

`systemctl stop ufw`

`systemctl disable ufw`

2. Устанавливаем пакет FRR:

`curl -s https://deb.frrouting.org/frr/keys.asc | sudo apt-key add -`

`echo deb https://deb.frrouting.org/frr $(lsb_release -s -c) frr-stable > /etc/apt/sources.list.d/frr.list`

`sudo apt update`

`apt install frr frr-pythontools`

3. Разрешаем (включаем) маршрутизацию транзитных пакетов:

`echo "net.ipv4.conf.all.forwarding = 1" >> /etc/sysctl.conf`

`sysctl -p`

4. Включаем демон ospfd в FRR. Для этого в файле `/etc/frr/daemons` меняем параметры для пакетов ospfd на yes:

image 1

5. Для настройки OSPF нам потребуется создать файл `/etc/frr/frr.conf` который будет содержать в себе информацию о требуемых интерфейсах и OSPF. Для начала нам необходимо узнать имена интерфейсов и их адреса. Сделать это можно двумя способами:

- посмотреть с помощью команды `ip a | grep inet`:

image 2

- зайти в интерфейс FRR и посмотреть информацию об интерфейсах:

image 3

В обоих примерах мы увидим имена сетевых интерфейсов, их ip-адреса и маски подсети. Исходя из схемы мы понимаем, что для настройки OSPF нам достаточно описать интерфейсы enp0s8, enp0s9, enp0s10.

Создаём файл `/etc/frr/frr.conf` и вносим в него следующую информацию:

image 4

Вместо файла frr.conf мы можем задать данные параметры вручную из vtysh. Vtysh использует cisco-like команды. На хостах router2 и router3 также требуется настроить конфигурационные файлы, предварительно поменяв ip -адреса интерфейсов. В ходе создания файла мы видим несколько OSPF-параметров, которые требуются для настройки:

- hello-interval — интервал который указывает через сколько секунд протокол OSPF будет повторно отправлять запросы на другие роутеры. Данный интервал должен быть одинаковый на всех портах и роутерах, между которыми настроен OSPF.

- dead-interval — если в течении заданного времени роутер не отвечает на запросы, то он считается вышедшим из строя и пакеты уходят на другой роутер (если это возможно). Значение должно быть кратно hello-интервалу. Данный интервал должен быть одинаковый на всех портах и роутерах, между которыми настроен OSPF.

- router-id — идентификатор маршрутизатора (необязательный параметр), если данный параметр задан, то роутеры определяют свои роли по данному параметру. Если данный идентификатор не задан, то роли маршрутизаторов определяются с помощью Loopback-интерфейса или самого большого ip-адреса на роутере.

6. После создания файлов `/etc/frr/frr.conf` и `/etc/frr/daemons` нужно проверить, что владельцем файла является пользователь frr. Группа файла также должна быть frr. Должны быть установлены следующие права:

- у владельца на чтение и запись

- у группы только на чтение Если права или владелец файла указан неправильно, то нужно поменять владельца и назначить правильные права

7. Перезапускаем FRR и добавляем его в автозагрузку:

`systemctl enable --now frr`

Если мы правильно настроили OSPF, то с любого хоста нам должны быть доступны сети:

- 192.168.10.0/24

- 192.168.20.0/24

- 192.168.30.0/24

- 10.0.10.0/30

- 10.0.11.0/30

- 10.0.12.0/30

Убедиться в этом можно пропинговав интерфейсы роутеров и/или посмотреть таблицу маршрутизации на наличие указанных маршрутов:

image 5

--------------------------------------------------------------------------------------------------

# 2.2. Настройка асимметричного роутинга

Разрешаем ассиметричную маршрутизацию:

`sysctl net.ipv4.conf.all.rp_filter=0`

Выбираем один из роутеров, на котором изменим «стоимость интерфейса». Например, поменяем стоимость интерфейса enp0s8 на router1:

image 6

Видим пакеты с router1 к сетям router2 теперь пойдут через router3.

Ответные пакеты c router2 к router1 пойдут по прежнему пути, сразу на router1:

image 7

Для проверки запускаем на router1 пинг от 192.168.10.1 до 192.168.20.1:

`ping -I 192.168.10.1 192.168.20.1`

На router2 запускаем tcpdump, который будет смотреть трафик только на порту enp0s9:

image 8

Видим что запросы приходят на интерфейс enp0s9.

На router2 запускаем tcpdump, который будет смотреть трафик только на порту enp0s8:

image 9

Видим, что ответы уходят с интерфейса enp0s9.

Таким образом мы имеем асимметричную маршрутизацию.

-------------------------------------------------------------------------------------------------

# 2.3. Настройка симметричного роутинга

Так как у нас уже есть один «дорогой» интерфейс, нам потребуется добавить ещё один дорогой интерфейс, чтобы у нас перестала работать асимметричная маршрутизация.

Так как в прошлом задании мы заметили что router2 будет отправлять обратно трафик через порт enp0s8, мы также должны сделать его дорогим и далее проверить, что теперь используется симметричная маршрутизация:

Поменяем стоимость интерфейса enp0s8 на router2:

image 10

Видим, что маршрут до сети 192.168.10.0/30 пойдёт через router2
